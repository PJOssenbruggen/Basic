---
title: "tfuhp: Tools for Understanding Highway Performance"
author: "Paul J. Ossenbruggen"
date: "2018-01-25"
bibliography: "CF.bibtex"
output: html_document
runtime: shiny
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE, warning = FALSE, message = FALSE, error = FALSE}
library(Basic)
```

## Overview 
 
The __tfunhp__ package is designed for college students studying transportation engineering and for transportation professionals and researchers interested in understanding the complex relationships associated with freeway performance and traffic breakdown. Newtons Laws of dynamics, fundamentals of trafic flow theory (TFT), probabilistic modeling and statistics are used in this package. By building upon current knowledge - the "classical methods" of transportation analysis - and integrating them with the latest computer tools, the goal is to identify key factors that initiate a breakdown event.  Emphasize is placed on:

##### Traffic noise or _traffic volatility_.

##### Driver behavior and safety.

##### Using stochastic models that explain breakdown.

The principal aim of this vignette is to explain highway performance as simply as possible. Topics are introduced in a  step-by-step manner.  Exploratory data analyses of a freeway bottleneck, inspecting a YouTube video of vehicles traveling on a ring road, and using the core assumptions of TFT are used for example.   The principal product of this effort is the development of a traffic flow model:

* $Q = f(k, u, \sigma, h)$

where $k$ is traffic density, $u$ is  speed, and $h$ is a headway.  Since traffic is a noisy process, speed  is treated as a random variable $U$, a function of both $u$ and  $\sigma$. The overall  volatility observed in the process  is specifified by $\sigma$, a measure of driver group dynamics and other uncerainties.  The variable  $h$, _safe distance headway_,  reflects the drivers' aversion to risk and vehicle length. Since $h$ is a safe distance headway,  no crashes are permitted.  Thus,  $Q$ is a random variable and an important measure of highway performance. The  $Q$ model is a _parsimonius, stochastic model._


## Introduction 

A quick read of the __Overview__ may give the impression that the approach, a package of computer algorithms, will be difficult to understand and overwhelming to implement. Words, like complex, dynamics, theory, parsimonious, stochastic and model integration can be daunting. No question that designing and operating a transportation system are difficult problems. By disecting the problem into manageable pieces and synthesizing the  results from the individual pieces brings clarity to the process. 

Consider a "toy" example using  _sequential-demand-forecasting. It is a 4-step approach. Questions associated with (1) _trip generation_, (2) _trip distribution_, (3) _modal-split_, and _trip assignment_ are asked.  Our task is to  improve an existing campus transporation system. This is no small task, especially when budgetary constraints are imposed. Suppose we obtained the following responses:

_Trip generation_, "What is the purpose of your trip?" Work, shopping, entertainment, doctor's visit, etc. and of course, returning home after completing these activites. Since our problem, deals traveling on campus, we  interview 10 students in this "toy" example. To further simplify the problem,  we assume that all students are together in the same classroom. The answers range to my next class in a different building, study hall, dining hall, etc. The answers, you can see, can be anticipated. You can see that answers are dependent on the time of day and may include  other factors. 

_Trip distribution_, "Where do you want to go?" Thus, for the students, we need to know the locations of class rooms, study halls, dining halls, etc. 

_Modal-split_, "What means of transporation will you use?" Walk, bicycle, auto, bus. For the general public, answers  include taxi, Uber, train, boat and airplane.

_Trip assignment_, "What route will you use?" Answers include sidewalks, local streets, boulevards, freeways, waterways, and the airways. 

To build a system for a campus with hundreds or thousands of students, more people will be interviewed. Of course, not all students, faculty, staff and administrators on the campus need to be interviewed. While a sample of 10 students is insufficient, a  _representative sample_ will suffice. A most important point, even for this "toy" example, is the need for quality data. Once obtained, statistical analysis  can be used to extract critical information from the data and to build predictive models.

## Visualizing the  Problem 

The [trfhp](https://github.com/PJOssenbruggen/Basic) package is  a collection of [R](https://www.r-project.org) functions and libraries. This  wide variety of statistical and graphical techniques are made available through the open-source [cran](https://cran.r-project.org) network.  The aim is to use these tools to  better understand freeway performance and traffic breakdown.  Computer simulation, enhanced graphics including animation, and sensitivity analysis are  used in the [trfhp](https://github.com/PJOssenbruggen/Basic) package.  For example, [ggplot2](http://ggplot2.org) from [Rstudio](https://www.rstudio.com/products/rpackages/)  is used to produce the animation presented below. [Shiny](http://shiny.rstudio.com) is used to build interactive web applications for conducting sensitivity analyses. 

Let's look again at trip generation. This time, we will incorporate visual imagry into the discussion. Before the interview, we don't know if the students will travel north, south, east or west or how far they will travel. We do know that they are all located at the same place initially and when the class ends that they will disperse. A [R](https://www.r-project.org) _Brownian motion model_, a time-dependent stochastic model, can simulate this behavior.  At time $t$ = 0, the students are  located at the point $(x = 0, y = 0)$. They become more dispersed as time progresses. Robert Brown, a botanist, described this chaotic motion of a grain of pollen suspended in water. This model is used by economists and physicists [@sde] [@iacus]. 


```{r tripdispersion,  message = FALSE, fig.height = 4, fig.width = 4, echo = FALSE}
library(ggplot2)
p1 <- tripdispersion(20, 123)
p2 <- tripdispersion(20, 002)
par(mfrow = c(1,2))
p1
p2
```

The mathematics behind the animation is relatively simple. Of course, the Brownian motion model shown here can be adapted to other situtations. This will be  illustrated presently. The ultimate aim of using [trfhp](https://github.com/PJOssenbruggen/Basic) package tools is to improve our chances of mitigating congestion and improving performance using the simple mathematical and graphical tools.

## Exploratory Data Analysis 

Our next step in this discussion is to investigate the traffic data and glean as much information  from _raw, real-world data._ First, we investigate relationships among of flow $q$, density $k$ and speed $u$ on the northbound lane on I-93 in Salem, New Hampshire. Next, we will look for meaningful relationships using visual imagry, scatter plots, box plots and time-series plots. Once these relationships are revealed, the next step is to develop mathematical models that capture these relationships.  

Unlike the "toy" example, 20,656 recordings of $q$, $k$ and $u$ were made over a period of eight months. The speed recordings are aggregate values.  The _space-mean speed_ is estimated as $u = n/(1/\sum u_i)$ where $u_i$ is an individual observation made in a 15-minute interval, $i = 1,2,..., n$ is vehicle identification number, and $n$ is the total number of vehicles observed in the interval. The flow for the interval is calculated as $q = n/t$ where $t$ is 15-minutes. The density is derived from the _fundamental relationship_ of traffic flow $q = k * u$. Thus, the density is estimated as $k = q/u$. The site is a __bottleneck__ because the number of lanes drops from three to two. By exploring the data, we will discover that congestion at the site is severe. 

A __Flow-Speed Plot__  scatter plot  reveals much about the traffic at the site.  For one, the data are  _extremely noisy or volatile_, therefore making it difficult to reveal clear-cut patterns in the data. By using scaling and color shading of the $k$ dots, the scatter plot become enhanced, making it easier to reveal patterns in the data. The smaller/black dots indicate fewer vehicles per mile than  the  large/blue dots. 

Even though the data are noisy, patterns are revealed. For one,  speeds between 60 and 80 miles per hour (mph) are observed at  flows ranging from 0 to 3000 vehicles per hour (vph). The speed tends to decrease marginally with an increase in flow. The densities  over this range increase but for the most part, do not exceed $k \le 70$ vehicles per mile (vpm). Given these results, $u^* =$ 50 mph is defined to be a critical speed where a _congested state_ and  a _free-flow state_ are defined to be $u \le u^*$ and  $u > u^*$, respectively.  Low speeds and high densities, $u \le u^*$ and $k > 70$ vpm, tend to be associated and define a congested state. 


```{r, echo = FALSE, fig.height = 4, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
library(dplyr)
library(ggplot2)
speedplot()
```

We continue to explore the relationship between $k$ and $u$ with  the __Box Plot of Density-Speed__.   To construct the diagram, the speed were sorted and placed into bins. For example, the labeled as $k^*$ = 45 vpm consists of observations ranging 42.5 to 47.5 vpm. This value of $k^*$ is taken from the Highway Capacity Manual (HCM), which defines it to be the roadway capacity for this geometric design. Visual inspection reveals that the chance of driving in a free-flow state, $u^* > 50$,  is greater when $k^* \le 45$ vpm. The interquartile range of speed is extremely tight for $k^* \le 45$ vpm. Excluding outliners, a driver can be assured that speeds of 70 mph or more can be expected. With the exception of the bin at $k$ = 50 vpm, speeds considerably less than 25 mph is expected for $k^* \ge 55$ vpm.  It is impossible to explain why so many congested speed observations are located in the $0 < k \le k^* = 50$ range. For $k \le 50$ vpm, a better case can be made that a congested state will be observed. 


```{r, echo = FALSE, fig.height = 4, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
library(dplyr)
library(ggplot2)
speedboxplot()
title("Box Plot of Density-Speed")
```

A __Time-Speed Plot__ draws attention to _traffic breakdown_, driving in a congested state with speeds of less than 50 mph, $u \le$  50 mph, is a common occurence. Simple inspection of the plot also reveals that _long delays, congestion lasting more than one hour, are common_. Remember a congested state is defined by speed,  $u \le 50$ mph. Also make note that each $(t,u)$ point on the figure represents a point-in-time denoted by $t$, which means the freeway is in a congested state for 15 minutes. Note that $t$ is not clock time but a time-index, each $t$ representing a time interval of 15 minutes. At the extreme right, for example, the freeway is observed to have a time index of $t$ = 36.  Thus,  time in a congested state in this instance is 36 / 4 = 9 hours.  

Statistic summaries of the data reveal interesting facts. The total number of breakdown events is counted to be 227. The total time the freeway is in a congested state is calculated to be 444 hours.  The average delay time is estimated to be 444/227 or about two hours. The breakdown count includes multiple breakdown in a single day. The chance of  a breakdown is estimated to be 4 in 5. Stated another way, four days in a five-day work week the freeway is congested state with speeds ranging from $10 < u < 20$ mph.

Of course, these statistical summaries are important performance measurements. However, they do not explain why traffic breakdown is so prevelent at the site. The data used in the __Time-Speed Plot__,  a subset of the data used in the __Flow-Speed Plot__ and  __Box Plot of Density-Speed__ diagrams, gives a different perspective. Note that the horizontal axis is labelled with time indices $t = -1,0,1,2, ...$. The first breakdown in a string of initial breakdown events is denoted as  t = 0$. Thus, $u_0$ is called the breakdown speed and $u_{-1}$ is called the pre-breakdown speed. 

The pre-breakdown $u_{-1}$ and breakdown $u_0$ speeds, even after filtering the data, are _extremely volatile_. Since $50 \le u_{-1} < 72$ mph is so wide a range, it cannot be used as an indicator or reliable predictor that a breakdown is likely to occur. 

The smooth blue curve,  a generalized additive model (gam), suggests that there may be a underlining structure associated with this chaos. Like above, the blue curve draws attention to the fact that congestion, $u \le 50$ mph,  can last a long time. It also draws attention to the fact that the average  speed drop is around 35 mph.

The blue curve must be used with care. It does not take over one-hour ($t$ = 5/4 = 1.25) for the speed to drop from  55 to 20 mph or speed drop of 35 mph. Again, remember the $t$ values are time indices, not clock times.   The blue curve is useful for inferences regarding speed drop but totally misleading with regard to times of occurrence.  Every driver knows that breakdown events occur on a time scale of seconds not minutes. 


```{r, echo = FALSE, fig.height = 4, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
library(dplyr)
library(ggplot2)
speedtsplot()
```

## Explaining Traffic Breakdown

We will turn our attention to explaining traffic breakdown. Basically, we are looking for an answer to  the following question: _What are the conditions that trigger a breakdown event?_ Choose one: (1) excessive demand, (2) driver characteristics, (3) both high demand and the driver behavior, and (4) all the above plus other factors. The best answer is (4). The next question is _What are the other factors?_ The results from our exploratory data analyses, given above, suggests that _traffic volatity_ is an addition factor. We will introduce a _Brownian motion model of speed_, a relatively simple  mathematical model, to help explain the breakdown process. In addition, since traffic breakdown involves traffic slowing down and in the worst case, stopping,  we use classical theory to describe vehicular deceleration. Lastly, since deceleration occurs quickly, in a matter of seconds, our analysis  will be performed in _microscale_ time or seconds.  

### The Ring-Road Experiment

We will begin our model building exercise by describing a single-lane _ring_ or _loop road_ where drivers cannot pass one another. Traffic breakdown at a _bottleneck_ is more complex because it requires traffic to merge. The analysis of a _loop road_ is more straightforward. Another simplying  assumption is that no vehicles are allowed to enter or exit the loop. The number of vehicles on the loop road is fixed and equal to $n$. 

Drivers travelling around a loop road will attempt to optimize the situation. They select a constant speed $u$ and constant headway $h$. Under these ideal conditions, drivers will travel steadily around the road without interruption.  The reality is that the drivers are unable to do so. Their speeds will vary by a slight amount and eventually, the vehicles will begin to interact. The situation is modelled by adding traffic noise $\sigma$ to the speed $u$. Assume speed $U(t)$ to be a Brownian motion model of the form: 

$U(t) = u + \sigma W(t) = u + \sigma \sqrt{\Delta t} Z$ 

where initial speed $u$ and standard deviation of speed $\sigma$ are constants, $W(t) = \sqrt{\Delta t} Z$ is Brownian motion, and time $t$ is measured in seconds. $Z$ is defined to be a standard normal probability distribution  where $Z \sim N(0,1)$, a standard-normal probability model,  and $\Delta t$ is defined to be the time step. The simulation where  $u$ = 30 mph, $\sigma$ = 3 mph, and $\Delta t$ = 0.5 second, shows a driver has difficluty maintaining  a speed of 30 mph.

```{r cfanim, echo = FALSE, fig.show='animate', ffmpeg.format='gif', dev='jpeg', fig.height = 4, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
library(gganimate)
library(gapminder)
library(ggplot2)
library(tidyverse)
set.seed(321)
p1 <- cfanim(30, 3, 30, 0.5)
p2 <- cfanim(30, 3, 30, 0.5)
par(mfrow = c(1,2))
p1
p2
```

Now, we turn our attention to modeling vehicular interaction, better known in the literature as _car following_. The deterministic _flow-density-speed_ relationship of $q = k * u$, is now treated as a random process of the form:

$Q = K * U(t)$

A traffic breakdown is  defined as above but in terms of the random variable of speed, $U \le u^* = 50$ mph. Time $t_0$ is the time the breakdown event is observed, thus $U(t_0) = u^*$. Time $t$, observed in this context, is measured in seconds. It is not a time-index as used above.

An interesting result occurs for the _loop road_. $K$ is not a random variable but a constant. $K = k = n /l$. The flow equation is rewritten as:

$Q = k * U(t) = n / l * U(t)$.

The volatility in $Q$ is explained exclusively by the volatility in $U(t)$. That is, $u$ and $\sigma$. 

 [@1367-2630-10-3-033001] produced a YouTube video, https://www.youtube.com/watch?v=7wm-pZp_mi0. The results from the video inspired the $Q = n / l * U(t)$ model. The number of vehicles traveling around the ring road  in the video is fixed at $n$ = 22 vehicles. Most importantly, the drivers are instructed to maintain a constant speed and distance headway $h$, the distance between the front bumpers, say, of the lead and following vehicles.  They cannot follow instructions. After a few sections, the traffic breaks down.

The $Q =  k * U(t)$ model exhibits the same behavior as shown in the YouTube video. Our results are shown as  time-distance $t-x$ trajectories  for $k$ = 55 vehicles per mile (vpm). See the __Congested Flow: Ring Road__ diagram. A same instructions given to the drivers of the Yuki Sugiyama experiment are assumed for the computer simulation that produced the $t-x$ trajectories. Maintain a constant speed and headway $h$.  The simulated drivers are assigned the same initial speed of $u$ = 30 miles per hour (mph) and are evenly placed along the $x$ axis at $t$ = 0.  The traffic density is fixed at $k$ = 55 vph. As in the full-scale experiment, the simulated drivers cannot maintain a constant speed or even spacing.  After a few seconds, the vehicles begin to interact and form clusters (moving queues) and the traffic breaks down. Setting $\sigma$ = 0, no clustering or breakdown can occur. _Clearly, traffic volatility plays an important role._

The __rrtrials__ computer simulation of the $Q =  n / l * U(t)$ model incorporates two important features not mentioned above: (1) _driver performance in a car-following situation_ and (2) _safety_. They are most easily explained with the use of the dotted and dashed lines shown in the figure. The dotted line is the trajectory of vehicle 1, the lead vehicle, assuming that its driver could maintain a constant speed. Since $x = u * t$, the slope of the dotted line is $u = 10$ mph. The dashed line is the trajectory of  vehicle 2  when vehicle 1  maintains the trajectory shown by the dotted line. Since vehicle 1 slows, vehicle 2 must slowdown to avoid a crash. The distance headways, measured by the distance between a lead/following pair, are safe distances. 

Level-of-service estimates for the simulation are shown in the following table. The mean headway $\bar{h}$ is the averages of the distances between points along the $x = 0$ axis. The predicted flow  for the simulation is estmated as $\hat{Q}  = 1/\bar{h}$. The standard deviation estimate of $\hat{\sigma}_h$  is an indicator that a breakdown is triggered by a volatile process associated with vehicle speed exclusively. Assuming no volatility $\sigma$ = 0, $q = k * u$  = 1650 vph and $h$ = 2.2 seconds at $x$ = 0. 
    
  |Mean headway $\bar{h}$ | Headway standard deviation $\hat{\sigma}_h$ |Predicted flow $\hat{Q}$ |
  |-----------------:|-------------------:| -----------------:|
  | 2.2 seconds | 1.6 seconds | 1650 vehicles per hour (vph)|
 
```{r, echo = FALSE, fig.height=4, fig.width= 6, message=FALSE, error=FALSE, warning = FALSE}
set.seed(124)
par(mfrow = c(1,2))
output <- rrtrials(30, 3, 55, 120, 5, 14, 100, c(0,100), c(-1000, 2000))
title("Congested Flow", "Ring Road")
hist(output[[7]], xlab = "headway, seconds", col = gray(0.8), breaks = seq(0,10), main = "")
box()
title("Headway", "Ring Road")
```
    
The $Q = k * U(t)$ model suggests a _cause-effect relationship_ exists:  $u$ and $\sigma$ are the causal factors and  $\hat{Q} = 1/ \bar{h}$ is the response variable. As illustrated, vehicle clustering occurs only when  density $k$ sufficiently dense. When there are fewer vehicles on the ring road, $k = n / l$ decreases resulting in longer time headways of $\bar{h}$. Under less dense conditions, drivers can vary their speeds without affecting one another, thus reducing the chance of breakdown. 

Overall, the $Q$ model predicts poor performance.  $\hat{Q} \le c^*$ = 2250 vph with speeds $\bar{u} \pm \sigma_U = 29 \pm 5$ mph. High volatility in speed and headway $h$, shown in the __Headway__ histogram, suggests driving under these conditions is unpleasant.

### Sensitivity Analysis


```{r echo = FALSE,  fig.height = 18, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
library(shiny)
server <- shinyServer(function(input, output){
    output$myspeed       <- renderText(input$speed)
    output$mydensity     <- renderText(input$density)
    output$myvol         <- renderText(input$vol)
    output$mytm          <- renderText(input$tm)
    output$mytstep       <- renderText(input$tstep)
    output$myleff        <- renderText(input$leff)
    output$mynobs        <- renderText(input$nobs)
    output$table         <- renderTable({
      umn <- reactive(as.numeric(input$speed))
      usd <- reactive(as.numeric(input$vol))
      k0  <- reactive(as.numeric(input$density))
      T   <- reactive(as.numeric(input$tm))
      dt  <- reactive(as.numeric(input$tstep))
      leff<- reactive(as.numeric(input$leff))
      nveh<- reactive(as.numeric(input$nobs))
      xlim<- c(0,60)
      ylim<- c(-2000,1000)
      headway <- rrtrials(umn(), usd(), k0(), T(), dt(), leff(), nveh(), xlim, ylim)[[7]][-1]
      q <- 3600/headway
      mn.headway <- round(mean(headway),2)
      sd.headway <- round(sd(headway),2)
      mn.q <- round(mean(q),0)
      sd.q <- round(sd(q),0)
      table <- data.frame(Headway.mean = mn.headway, Headway.SD = sd.headway, Flow.mean = mn.q, Flow.SD = sd.q)
  #    row.names(table) <- c("Headway, seconds")
    })
    output$plot         <- renderPlot({
      umn <- reactive(as.numeric(input$speed))
      usd <- reactive(as.numeric(input$vol))
      k0  <- reactive(as.numeric(input$density))
      T   <- reactive(as.numeric(input$tm))
      dt  <- reactive(as.numeric(input$tstep))
      leff<- reactive(as.numeric(input$leff))
      nveh<- reactive(as.numeric(input$nobs))
      xlim<- c(0,60)
      ylim<- c(-2000,1000)
      headway <- rrtrials(umn(), usd(), k0(), T(), dt(), leff(), nveh(), xlim, ylim)[[7]][-1]
      q <- 3600/headway
      hist(q, col = gray(0.8))
      par(mfrow = c(1,2))
      hist(headway, col = gray(0.8), xlab = "h, seconds", main = "Headway", breaks = seq(min(headway),max(headway)+1),0.5)
      length(headway)
 #     curve(headway, add = TRUE, col = "blue")
      hist(q, col = gray(0.8), xlab = "q, vph", main = "Flow", breaks = seq(min(q)-250,max(q)+250,250))
  #    curve(q, add = TRUE, col = "blue")
    })
  }
)

ui <- shinyUI(fluidPage(
  titlePanel("Traffic Flow Q: A Random Variable"),
  sidebarLayout(
    sidebarPanel((h4("Cause")),
                 sliderInput("speed",    "Speed, mph",  min = 0, max = 100, value = 30, step = 5),
                 sliderInput("density",  "Density, vpm", min = 5, max = 110, value = 55, step = 5),
                 sliderInput("vol",      "Speed volatility, mph", min = 0, max = 20, value = 3, step = 0.5),
                 sliderInput("tm",       "Time, seconds", min = 5, max = 120, value = 60, step = 5),
                 sliderInput("tstep",    "Time step, seconds", min = 1, max = 10, value = 5, step = 0.5),
                 sliderInput("leff",     "Vehicle length, feet", min = 5, max = 25, value = 14, step = 2.5),
                 sliderInput("nobs",     "Number of observations", min = 30, max = 200, value = 100, step = 10)
    ),
    mainPanel((h4("Effects")),
             tableOutput("table"),
             plotOutput("plot", width = "100%", height = "400px")
    )
  )
)
)
shinyApp(ui = ui, server = server)
```



### A Zipper Merge

Now, we turn attention to a bottleneck where there is a lane drop from two to one-lane. To better understand to various factors that can affect a breakdown, we will investigate a "zipper merge." 

Imagine that we shrink ourselves down to a size that is sufficiently small to observe a zipper close. That's right, a zipper. Let's say, a jacket zipper. We will stand on the zipper pull and look in the direction where zipper tapes are separated.  This is analogous to standing on the side of a roadway looking upstream where the vehicles merge at a bottleneck. Regardless of how fast the zipper slider is pulled, the zipper tapes become secure when meshed together because the rows of zipper teeth are the same size, move at the same speed, are evenly spaced and aligned to allow the two tapes to link together. The incoming vehicles on a freeway, on the other hand, are typically not the same size, not traveling at the speed, not evenly spaced, and not aligned. Instead, vehicles must change speed and carefully merge together to avoid crashing into one another.  It is possible to achieve a zipper merge under high-speed conditions. This occurs on a motor raceway where the drivers are professionals.

To realistically depict driver behavior at a freeway bottleneck, a  time-varying acceleration  function is used:

$\alpha(t) = a - b t$

where $t$ denotes time. The constants $a$ and $b$ are estimated by using boundary conditions. Knowing  $\alpha(t)$, speed $u(t) and distance $x(t)$ can be forecast as shown  in the __Vehicles entering a Bottleneck__ animation. The __zipper()__ function calls the two __R__  packages as shown. 

```{r, fig.show = 'animate', ffmpeg.format ='gif', dev = 'jpeg', echo = FALSE, fig.height = 4, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
library(animation)
library(dplyr)
library(gganimate)
library(gapminder)
library(ggplot2)
library(tidyverse)
tstart <- 0
tend   <- 10
ustart1 <- 25
uend1   <- 25
xstart1 <- 0
xend1   <- 250
ustart2 <- 25
uend2   <- 25
xstart2 <- 0
xend2   <- 300
ustart3 <- 30
uend3   <- 25
xstart3 <- -50
xend3   <- 275
title <- "Zipper Merge"
zipper(tstart,tend,ustart1,uend1,xstart1,xend1,ustart1,uend2,xstart2,xend2,ustart3,uend3,xstart3,xend3,title)
```

The animation depicted here consists of three vehicles. The driver of vehicle 3 is more aggressive than the other two drivers. Driver 1, who is the least aggressive, maintains a constant speed of 25 mph. Note that $a$ = $b$ = 0 for this driver. The $t-x$ trajectory for vehicle 1 is a straight line with a constant slope of 25 * 5280/3600 = 36.7 feet per second (fps). The trajectories for vehicles 1 and 2 are non-linear. The merge is complete after 10 seconds. At the end of the merge, all vehicles are traveling at $u$ = 25 mph and have a distance headway of $h$ = 25 feet, which is assumed to be a safe distance for this speed. 

Vehicle alignment is important even for this simple simulation. At $t$ = 0, the $t-x$ trajectory shows the vehicles 1 and 2 are located at $x$ = 0 and vehicle 3, which is following vehicle 2, is   located at $x$ = -50 feet.

Initially, vehicles 1 and 2 are traveling side-by-side in separate lanes on a 24-foot freeway for $x$ = 0 to hold. Further assume these vehicles are traveling in the middle of their respective lanes. Since the lane widths are 12 feet, the centerline distance between them is 12 feet.

A primary reason for showing this animation is to discuss the importance of a $t-x$ trajectory and to describe the features of the   $\alpha(t) = a - b t$ velocity model. For example, the headways before and after the merge are $h$ = 50 and 25 feet, respectively. This is easily seen on the $t-x$ trajectory diagram.  The traffic density at the merge is twice  the value of a single lane upstream. Now, look at $a$, $b$, the maximum speeds of vehicle 1, 2 and 3 are 25, 32.5 and 35 mph, respectively. These speeds are within the law. Vehicle 3, whose driver is most aggressive, reaches a maximum speed of 35 mph at 4.2 seconds and then slows down to 25 mph. 

_A critical question do these drivers drive safety?_ Since the driver of vehicle 1 maintains a constant speed of 25 mph, we will answer, "Yes." The answer for vehicle 2 is the same, "Yes." Driver 2 reaches a maximum speed of 32.5 mph before returning to a speed of 25 mph. The trajectory for vehicle 3 "crosses" the trajectory of vehicle 1, suggesting that a side-swipe crash or near-miss may take place at $t = 6.5$ seconds.  At this point in time, the centerline distance between the two vehicles is less than 6 feet and the potential for a crash is high. Is driver 3 to blame? Let us investigate the situation further.

At around $x$ = 50 feet or around $t$ = 2 seconds, driver 1 can see that  vehicle 3 is passing. Driver 1 has the responsibility to decelerate his or her vehicle and has ample time to do so, thus avoid a crash. The trajectories of the two vehicles would "cross" but at a point in time where the two vehicles have much more room to manuever. In other words, "crossing trajectories" can serve a warning of potential risk. The time when trajectories "cross" dictates the outcome.

Getting back to the question about driving safely. All drivers are operating within the law, then we must conclude _all drivers are driving safely._

The simulation model describes and explains the _triggering of a traffic breakdown event_ for three vehicles. It is used to introduce car-following modeling.

### Car-Following Modeling and Breakdown

_Car-following_ models  describe and simulate the traffic behavior  by designating   _lead_ and  _following_ vehicles. After the merge described above, vehicle 2 becomes a _lead_  vehicle. The actions of the _lead_ vehicle  affects the _following_ vehicles from lanes 1 and 2. The description that follows will be similiar to the behavior described above for the ring road. The $Q =  n / l * U(t)$ model is used. There are features in the following examples that we have seen before. 

Again, we assume a freeway narrows from two-lanes to one. The results are shown in the __Breakdown: Bottleneck__ diagram.  The number of vehicles in the simulation remains fixed, $n$ = 10. The lead vehicle, denoted as 1 in the figure, approaches the bottleneck at a speed of 63 mph and decelerates to a speed of 34 mph. See the __Time-Speed Plot__. The lead vehicle reaches this breakdown speed of 34 mph at $x$ = 0 as shown by the point $(t_3,0)$. All following drivers must reduce their speed to avoid colliding into the vehicle in front of them. 

 ```{r, echo = FALSE, fig.height = 4, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
set.seed(123)
cflist <- run(10, 63, 10, 34, 0.1, 55, 5, 15, 14, c(0, 60), c(-2000, 5000))
title("Breakdown", "Bottleneck")
```

Over the time range of 60 seconds, the speed reduction in the lead vehicle forces the following vehicles to become more closely spaced. All drivers keep a safe headway, one vehicle length for each 10 mph of speed. The $t-x$ trajectory of the ten vehicles shown in the figure give the impression that the vehicles arrive with the same speed and headway. In fact, this is not the case:

``` {r, echo = FALSE, message=FALSE, error=FALSE, warning = FALSE}
mat <- cflist[[2]]
mat <- round(mat,0)
df  <- data.frame(mat)
colnames(df) <- c("Vehicle", "Speed at t0", "Speed at t3",   "Density at t1")
knitr::kable(df, caption = "Traffic Characteristics", align = "c")
```
    
The level-of-service estimates are:

  |Mean headway $\bar{h}$ | Headway standard deviation $\hat{\sigma}_h$ |Estimated flow $\bar{q}$ |
  |-----------------:|-------------------:| -----------------:|
  | 6.7 seconds | 20 seconds | 537 vehicles per hour (vph)|
  
Contrast the "Bottleneck" situation  to  where the same vehicles come a full stop at a signal.  The "Full Stop" vehicles experience longer delays as can be seen in the following diagram, which is no surprise. The "Full Stop" vehicles are stacked up on the downstream side of the $x = 0$ line. It forms shockwave of stopped vehicles that move upstream. The "Bottleneck"  shows the shockwave moving upstream of vehicles that are to slow down. 

```{r, as.is = TRUE, echo = FALSE, fig.height = 4, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
library(knitr)
cflist <- run(10, 63, 10, 0,  0,  55, 5, 15, 14, c(0, 20),c(-1000, 200))
title("Breakdown", "Signalized Intersection")
```

The classical approach is to calculate shock wave speed using the $\Delta q/ \Delta k$ formula and a flow-density diagram. Our car-following $CF$ approach uses the $\alpha(t) = a - b t$ model and a function that assures the drivers drive safely. It does not use a flow-density diagram. 

This approach explains  queue formation differently.  The $CF$  approach  shows the transistion from a free-flow to a congested state, the $u_{-1}$ to $u_0$ transition, to be smooth, not an abrupt change as with the classical method using a constant velocity model. The "Bottleneck" vehicles  show the $u_{-1}$ to $u_0$ transition to be moving upstream. That means the delay spreads in two directions, upstream and downstream.  The "Full Stop" vehicles have two shockwave speeds: one for breaking at $t_1$ and one for the vehicle when it stops at $t_3$.  Both progress in the upstream direction only. Incidentally, these shockwave speeds can be estimated with the trajectories.


Input to the __run__ function produces a collection of data frames, which we call the "cflist." The information from these data frames can be inspected to give a detailed look at the interaction between the lead and following vehicles during a traffic breakdown. 

###  Understanding the CF Breakdown Model 

The above figures show that the trajectories to be smooth curves.  The lead vehicle use  exponential $u = exp(-\lambda * t)$ and the following vehicles use non-linear $\alpha(t) = a - b t$ speed models. Depending on the situation, each driver  adjusts his or her speed independently from one another. The lead vehicle shown below has a concave trajectory from $t_0$ to $t_3$,  indicating a decline  in speed. Vehicle 2 and 3 have linear and convex trajectories. For vehicle 3, the driver is accelerating until reaches point $(t_1, x_2)$ where it begins to decelerate. 

```{r, echo = FALSE, fig.height = 4, fig.width = 6, message=FALSE, error=FALSE, warning = FALSE}
set.seed(123)
nveh <- 3
ulead <- 63
ulead.sd <- 10
ubrkdown <- 34
ubrkdown.sd <- 0.1
k <- 55
k.sd <- 5
d <- 15
leff <- 14
xlim <- c(0,12)
ylim <- c(-600, 600)
cflist <- run(nveh, ulead, ulead.sd, ubrkdown, ubrkdown.sd, k, k.sd, d, leff, xlim, ylim)
points(2.459226, -183.3195, pch = 8, cex = 0.5)
points(7.069598, 177.2323 + hsafe(53.89641, 14), pch = 8, cex = 0.5)
points(4.179863, -233.8204, pch = 8, cex = 0.5)
points(9.047542, 219.6009 + hsafe(53.89641, 14), pch = 8, cex = 0.5)
lines(c(4.179863,9.047542), c(-233.8204,219.6009  + hsafe(53.89641, 14)), lty = 5, col = gray(0.5))
text(2.459226, -183.3195, labels = expression("("*t[1]*","*x[1]*")"),pos = 3, cex = 0.75)
text(4.179863, -278.8204, labels = expression("("*t[1]*","*x[1]*")"),pos = 3, cex = 0.75)
text(7.069598, 177.2323 + hsafe(53.89641, 14), labels = expression("("*t[2]*","*x[2]*")"),pos = 3, cex = 0.75)
text(9.047542, 219.6009 + hsafe(53.89641, 14), labels = expression("("*t[2]*","*x[2]*")"),pos = 3, cex = 0.75)
text(4.56, 0, labels = expression("("*t[5]*",0)"),pos = 3, cex = 0.75)
text(6.7, 0, labels = expression("("*t[5]*",0)"),pos = 3, cex = 0.75)
legend("topleft", legend = "driver sight-lines", bty = "n", lty = 5, col = gray(0.5))
title("Breakdown","Basic Concepts and Notation")
```
 
Driver reaction and driver sight lines play  important roles in the $CF$ approach. The role they play is most easily explained by identifying the times when important events occur, $t_1, t_2, t_3, t_4$ and $t_5$. The simulation ranges from  $t_0$ to $t_4$. Time $t_3$ is the time the lead vehicle reaches the bottleneck $x_0$ at $(t_0,x_0)$. Times $t_1$ are the times the following vehicle drivers react and begin to decelerate. These times depend on several factors, including lead and  following vehicle speeds, vehicle spacing and driver response. For example, the driver sightline for  vehicle 2, shown by the broken line connecting the points $(t_1, x_1)$ and $(t_2, x_2)$, gives a sense of how this  driver processes the information. The algorithm uses this information, points $(t_1, x_1)$ and $(t_2, x_2)$,  to calibrate the $\alpha(t) = a - b t$ speed model and estimate a $t-x$ trajectory for the vehicle. This step is repeated for next vehicle that enters the bottleneck.  The trajectories for each of three vehicles shown in the graph are unique. Times $t_5$ are the times a following vehicle reach the bottleneck location $x = 0$. They are used to estimate the time headways between vehicles, which in turn are used to estimate traffic flow $\hat{Q}$.

### Theory Explaining Breakdown at a Bottleneck

Exploratory data analysis showed the traffic on I-93 in Salem to be extremely volatile and the chance of traffic breakdown is strong. Given these observations, it is natural to express the _fundamental relationship_ of traffic flow as $Q = K * U$ where $Q$, $K$ and $U$ are assumed to be random variables. However, the results of the ring-road experiment gave evidence that the variability in $Q$ depends wholly on the variability in speed, which we assumed to be a Brownian motion model $U(t)$. The argument was simple. Since the number of vehicles on the road $n$ and road length $l$ are constants, it follows that the density must be a constant.  Since $k = n/l$, $Q = k * U(t)$.  Our conclusions were derived from watching a short video and assuming flow, density and speed are measured on a time scale in seconds. 

The argument for the  $Q = K * U$ model is based upon _macroscale_ observations or averages of flow, density and speed derived from 15-minute averages. In contrast, the argument for the  $Q = k * U(t)$ model is based upon assuming variables are measured on the _microscale_. Certainly, the simpler  $Q = k * U(t)$ model is the model of choice for  bottleneck breakdown because we can envision why driver behavior can trigger a breakdown. The vehicles must merge at a bottleneck. In addition, many drivers, who drive this roadway on a regular basis, weave from one lane to another. Drivers in the NH and MA are known for their aggressiveness. By being so aggressive, they increase the traffic volatility by abruptly accelerating and decelerating. The $CF$ approach is a tool can be refined to study aggressive driver behavior. 

To justify the  $Q = k * U(t)$ model for a bottleneck, consider a "thought experiment." In addition to collecting speed $u_i$ data that we described above for the eight  month I-93 study, a series of videos are simultaneously taken by a helicopter flying overhead or by a drone. The video data will be used to obtain direct measures of density  $k_i = n_i/l$.  Next, take the matched $k_i$ and $u_i$ records, sort them into bins according to magnitude of traffic density, and construct a box plot. This sorting procedure treats the density data as fixed values or constants and the speed data as a random variable.

The box plot will arguably resemble of  the __Box Plot of Density-Speed__ diagram of I-93 study data presented above in the __Exploratory Data Analysis__ section. Assuming the "thought experiment" and I-93 study data sufficiently similiar, inferences can be drawn from I-93 box-plot. By visual inspection, speed decreases as the traffic density increases. Since the bottleneck geometry is unchanged throughout the experiment, the number of vehicles $n_i$ and speed $u_i$ are strongly associated. Thus, the $Q = k * U(t)$ model holds. 

To be absolutely clear about the meaning of the $Q = k * U(t)$ model for the Brownian motion speed model, $U(t) = u + \sigma W(t) = u + \sigma \sqrt{\Delta t} Z$, we rewrite it in functional form to draw attention to the _key variables_:

* $Q = f(k, u, \sigma, h)$

where $k = n/l$ = traffic density, $u$ = design speed,  $\sigma$ = standard deviation of $u$, and  $h$ represents a safe headway for vehicles of the same length.    

### Breakdown Event Forecasting

Inspecting $t-x$ trajectories and $h$ histograms derived from the $Q$ model  proves to be an effective in understanding traffic breakdown and explaining being in a congested state. Given $k$, it is possible to predict  probability of traffic breakdown  $\pi$. To gain an appreciation of the  $\hat{\pi}$ forecast model, look at the  __Box Plot of Density-Speed__ diagram.  We select bin of $k$ and then determine the proportion of breakdowns $p$ in the bin.  $p$ is straightforwardly calculated as the ratio of the number of observations where $u \le u^*$ to the total number of observations in the bin $k$. As previously mentioned, the HCM designates roadway capacity $c^*$ to be in the vicinity 2250 vph  at $k^*$ = 45 vpm. The estimate of $p$  for this bin is quite small. However, as  the $k$ values increase, the values of $p$ increase rapidly. Expressing $\pi$ by _time-of-day_ we have a wortwhile tool, _a macroscale model_, that traffic operators and managers may find useful:

$\hat{\pi} = P(K_t \ge k^*)$ 

$K_t$ is a stochastic differential equation model of traffic density by _time-of-day_ $t$ [@pjo2017](https://github.com/PJOssenbruggen/Basic/blob/master/doc/IEEE_MT-ITS.pdf).  Treating traffic density $K_t$ as the random variable  may seem contradictory given the discussion about the $Q = k * U(t)$ model. It is not. Note that two models are different. One is a _macroscale_ model predicting breakdown and the other one is a _microscale_ model predicting flow.  

## Summary

_What have we learned about traffic performance using the __tfuhp__ package?_ The most notable lesson learned is:

* By modeling driver behavior with a simple, parsimonious  Brownian motion model of speed, it is possible to explain and forecast  traffic  breakdown on a ring-road and at a bottleneck.  

The potential of the __tfuhp__ package as a learning tool has been demonstrated. Hopefully, this platform can be adapted and expanded to help users  identify the root cause or causes for other congestion problems. My next task is add __R Markdown Shiny__ HTML widgets to my code. Adding this feature will allow the user to simply conduct sensitivity analyses on-line. For example, the effects of speed  and density on ring-road performance can be explored. Sliders for $u$, $\sigma$ and $k$ will be provided so a user change them at will. The __tfuhp__ package will instantaneously produce a histogram of headways as illustrated above.

This package is open to the public, https://github.com/PJOssenbruggen/Basic. In other words, I am inviting people to share their experiences with the package with me. GitHub promotes this activity, https://github.com/explore.

# References


